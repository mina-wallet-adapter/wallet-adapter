import{T as g,i as D,a as I,l as w,b as y,D as x,c as S,h as _,d as k}from"./chunk-QP2J4BJS.DJ_OnwMQ.js";var o=function(n,e,t,i){function s(d){return d instanceof t?d:new t(function(c){c(d)})}return new(t||(t=Promise))(function(d,c){function l(r){try{u(i.next(r))}catch(v){c(v)}}function a(r){try{u(i.throw(r))}catch(v){c(v)}}function u(r){r.done?d(r.value):s(r.value).then(l,a)}u((i=i.apply(n,e||[])).next())})},E=[{vendorId:w}],L=()=>Promise.resolve(!!(window.navigator&&window.navigator.hid)),p=()=>{const{hid:n}=navigator;if(!n)throw new S("navigator.hid is not supported","HIDNotSupported");return n};function b(){return o(this,void 0,void 0,function*(){const n=yield p().requestDevice({filters:E});return Array.isArray(n)?n:[n]})}function m(){return o(this,void 0,void 0,function*(){return(yield p().getDevices()).filter(e=>e.vendorId===w)})}function R(){return o(this,void 0,void 0,function*(){const n=yield m();return n.length>0?n[0]:(yield b())[0]})}var f=class h extends I{constructor(e){super(),this.channel=Math.floor(Math.random()*65535),this.packetSize=64,this.inputs=[],this.read=()=>this.inputs.length?Promise.resolve(this.inputs.shift()):new Promise(t=>{this.inputCallback=t}),this.onInputReport=t=>{const i=Buffer.from(t.data.buffer);this.inputCallback?(this.inputCallback(i),this.inputCallback=null):this.inputs.push(i)},this._disconnectEmitted=!1,this._emitDisconnect=t=>{this._disconnectEmitted||(this._disconnectEmitted=!0,this.emit("disconnect",t))},this.exchange=t=>o(this,void 0,void 0,function*(){return yield this.exchangeAtomicImpl(()=>o(this,void 0,void 0,function*(){const{channel:s,packetSize:d}=this;y("apdu","=> "+t.toString("hex"));const c=_(s,d),l=c.makeBlocks(t);for(let r=0;r<l.length;r++)yield this.device.sendReport(0,l[r]);let a,u;for(;!(a=c.getReducedResult(u));){const r=yield this.read();u=c.reduceResponse(u,r)}return y("apdu","<= "+a.toString("hex")),a})).catch(s=>{throw s&&s.message&&s.message.includes("write")?(this._emitDisconnect(s),new x(s.message)):s})}),this.device=e,this.deviceModel=typeof e.productId=="number"?D(e.productId):void 0,e.addEventListener("inputreport",this.onInputReport)}static request(){return o(this,void 0,void 0,function*(){const[e]=yield b();return h.open(e)})}static openConnected(){return o(this,void 0,void 0,function*(){const e=yield m();return e.length===0?null:h.open(e[0])})}static open(e){return o(this,void 0,void 0,function*(){yield e.open();const t=new h(e),i=s=>{e===s.device&&(p().removeEventListener("disconnect",i),t._emitDisconnect(new k))};return p().addEventListener("disconnect",i),t})}close(){return o(this,void 0,void 0,function*(){yield this.exchangeBusyPromise,this.device.removeEventListener("inputreport",this.onInputReport),yield this.device.close()})}setScrambleKey(){}};f.isSupported=L;f.list=m;f.listen=n=>{let e=!1;R().then(i=>{if(!i)n.error(new g("Access denied to use Ledger device"));else if(!e){const s=typeof i.productId=="number"?D(i.productId):void 0;n.next({type:"add",descriptor:i,deviceModel:s}),n.complete()}},i=>{n.error(new g(i.message))});function t(){e=!0}return{unsubscribe:t}};var C=f;export{C as default};
