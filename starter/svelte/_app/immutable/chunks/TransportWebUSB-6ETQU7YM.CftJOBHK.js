import{i as D,e as _,T as I,a as B,l as x,f as m,b as y,D as T,d as U,h as E}from"./chunk-QP2J4BJS.DJ_OnwMQ.js";var p=function(c,e,o,t){function a(n){return n instanceof o?n:new o(function(i){i(n)})}return new(o||(o=Promise))(function(n,i){function d(r){try{s(t.next(r))}catch(f){i(f)}}function u(r){try{s(t.throw(r))}catch(f){i(f)}}function s(r){r.done?n(r.value):a(r.value).then(d,u)}s((t=t.apply(c,e||[])).next())})},N=[{vendorId:x}];function S(){return p(this,void 0,void 0,function*(){return yield navigator.usb.requestDevice({filters:N})})}function g(){return p(this,void 0,void 0,function*(){return(yield navigator.usb.getDevices()).filter(e=>e.vendorId===x)})}function L(){return p(this,void 0,void 0,function*(){const c=yield g();return c.length>0?c[0]:S()})}var M=()=>Promise.resolve(!!navigator&&!!navigator.usb&&typeof navigator.usb.getDevices=="function"),l=function(c,e,o,t){function a(n){return n instanceof o?n:new o(function(i){i(n)})}return new(o||(o=Promise))(function(n,i){function d(r){try{s(t.next(r))}catch(f){i(f)}}function u(r){try{s(t.throw(r))}catch(f){i(f)}}function s(r){r.done?n(r.value):a(r.value).then(d,u)}s((t=t.apply(c,e||[])).next())})},k=1,w=3,v=class h extends B{constructor(e,o){super(),this.channel=Math.floor(Math.random()*65535),this.packetSize=64,this._disconnectEmitted=!1,this._emitDisconnect=t=>{this._disconnectEmitted||(this._disconnectEmitted=!0,this.emit("disconnect",t))},this.device=e,this.interfaceNumber=o,this.deviceModel=D(e.productId)}static request(){return l(this,void 0,void 0,function*(){const e=yield S();return h.open(e)})}static openConnected(){return l(this,void 0,void 0,function*(){const e=yield g();return e.length===0?null:h.open(e[0])})}static open(e){return l(this,void 0,void 0,function*(){yield e.open(),e.configuration===null&&(yield e.selectConfiguration(k)),yield b(e);const o=e.configurations[0].interfaces.find(({alternates:i})=>i.some(d=>d.interfaceClass===255));if(!o)throw new m("No WebUSB interface found for your Ledger device. Please upgrade firmware or contact techsupport.");const t=o.interfaceNumber;try{yield e.claimInterface(t)}catch(i){throw yield e.close(),new m(i.message)}const a=new h(e,t),n=i=>{e===i.device&&(navigator.usb.removeEventListener("disconnect",n),a._emitDisconnect(new U))};return navigator.usb.addEventListener("disconnect",n),a})}close(){return l(this,void 0,void 0,function*(){yield this.exchangeBusyPromise,yield this.device.releaseInterface(this.interfaceNumber),yield b(this.device),yield this.device.close()})}exchange(e){return l(this,void 0,void 0,function*(){return yield this.exchangeAtomicImpl(()=>l(this,void 0,void 0,function*(){const{channel:t,packetSize:a}=this;y("apdu","=> "+e.toString("hex"));const n=E(t,a),i=n.makeBlocks(e);for(let s=0;s<i.length;s++)yield this.device.transferOut(w,i[s]);let d,u;for(;!(d=n.getReducedResult(u));){const s=yield this.device.transferIn(w,a),r=Buffer.from(s.data.buffer);u=n.reduceResponse(u,r)}return y("apdu","<= "+d.toString("hex")),d})).catch(t=>{throw t&&t.message&&t.message.includes("disconnected")?(this._emitDisconnect(t),new T(t.message)):t})})}setScrambleKey(){}};v.isSupported=M;v.list=g;v.listen=c=>{let e=!1;L().then(t=>{if(!e){const a=D(t.productId);c.next({type:"add",descriptor:t,deviceModel:a}),c.complete()}},t=>{window.DOMException&&t instanceof window.DOMException&&t.code===18?c.error(new _(t.message)):c.error(new I(t.message))});function o(){e=!0}return{unsubscribe:o}};var R=v;function b(c){return l(this,void 0,void 0,function*(){try{yield c.reset()}catch(e){console.warn(e)}})}export{R as default};
